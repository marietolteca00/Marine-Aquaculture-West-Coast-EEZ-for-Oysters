---
title: "Marine Aquaculture U.S. West Coast-Exclusive Economic Zones"
subtitle: "Identifying Suitable Habitat for Marine Species"
author: "Marie Tolteca"
date: 11/29/2025
format: html
---

# Importing libraries
```{r, message=FALSE}
library(tidyverse)
library(sf)
library(terra)
library(dismo)
library(tmap)
library(here)
library(knitr)
library(kableExtra)
library(dplyr)

```

# Import Data
```{r, message=FALSE, output=FALSE}
# load raster dataset
avg_08 <- rast(here("data","average_annual_sst_2008.tif"))
avg_09 <- rast(here("data","average_annual_sst_2009.tif"))
avg_10 <- rast(here("data","average_annual_sst_2010.tif"))
avg_11 <- rast(here("data","average_annual_sst_2011.tif"))
avg_12 <- rast(here("data","average_annual_sst_2012.tif"))

depth <- rast(here("data","depth.tif"))

# Reading in Shapefile- EEZ Data
regions <- st_read(here("data", "wc_regions_clean.shp"),  quiet = TRUE)


```

### Matching CRS for Rasters
```{r}
# check and transform coordinate reference systems
if(crs(avg_08) == crs(avg_09)) {
  print("Coordinate reference systems match:)")
} else{
  warning("Updating coordinate reference systems to match :(")}

# check and transform coordinate reference systems
if(crs(avg_08) == crs(avg_10)) {
  print("Coordinate reference systems match:)")
} else{
  warning("Updating coordinate reference systems to match :(")}

# check and transform coordinate reference systems
if(crs(avg_08) == crs(avg_11)) {
  print("Coordinate reference systems match:)")
} else{
  warning("Updating coordinate reference systems to match :(")}

# check and transform coordinate reference systems
if(crs(avg_08) == crs(avg_12)) {
  print("Coordinate reference systems match :)")
} else{
  warning("Updating coordinate reference systems to match :(")}

# check and transform coordinate reference systems
if (crs(avg_08) == crs(depth)) {
  print("Coordinate reference systems match :)")
} else {
  warning("Updating coordinate reference systems to match :(")
  # transform raster to match avg_08
  depth <- project(depth, crs(avg_08))
}

# check and transform coordinate reference systems
if (crs(avg_08) == crs(regions)) {
  print("Coordinate reference systems match :)")
} else {
  warning("Updating coordinate reference systems to match :(")
    # transform raster to match avg_08
  regions <- st_transform(regions, crs(avg_08))
}


```
#### Combine SST rasters into a raster stack
```{r}
# Combining rasters
sst_stack <- c(avg_08, avg_09, avg_10, avg_11, avg_12)

# Mean of all Rasters and Converting temp values  K -> °C
sst_mean <- mean(sst_stack) - 273.15
names(sst_mean) <- "sst_mean"

```

#### Checking Crop, Extent, Resolution
```{r}
# Obtain geographic extent/bounding box of species occurrences
st_bbox(sst_mean)

# Crop depth to the SST extent 
depth_crop <- crop(depth, ext(sst_mean))

# Resample depth to match SST resolution
depth_resampled <- resample(depth_crop, sst_mean, method = "near")

# Check Resolution
if (all(res(sst_mean) == res(depth_resampled))) {
  print("Resolutions matche :)")
} else {
  print("Fix resolution :(")
}

# Check Extent
if (all(ext(sst_mean) == ext(depth_resampled))) {
  print("Extent matches :)")
} else {
  print("Fix Extent :(")
}

# Check CRS
if (crs(sst_mean) == crs(depth_resampled)) {
  print("CRS matches :)")
} else {
  print("Fix CRS :(")
}

```


# Find Suitable Locations for Depth and SST
To find suitable locations for marine aquaculture, we’ll need to find locations that are suitable in terms of both SST and depth.
```{r, message =FALSE}
# Define the reclassification matrix for SST - sea level
rcl_sst <- matrix(c(-Inf, 11, 0, 
                        11, 30, 1,
                        30, Inf, 0), ncol = 3, byrow = TRUE)

# Use classify function
reclassified_sst <- terra::classify(sst_mean, rcl = rcl_sst)


# Define the reclassification matrix for Depth
rcl_depth <- matrix(c(-Inf, -70, 0, 
                        -70, 0, 1,
                        0, Inf, 0), ncol = 3, byrow = TRUE)

# Use classify function
reclassified_depth <- classify(depth_resampled, rcl_depth)

# Combine Oyster and Depth for suitability
suitable <- reclassified_sst * reclassified_depth # Min = 0, Max = 1

# Map it
tm_shape(suitable)+
  tm_raster()+
  tm_title("Suitability- Depth and Location")+
  tm_layout(
  legend.outside.position = TRUE)+
tm_scale_bar(position = c(-.01, 0.08)) +
tm_compass(position = c("left", "top"))+
  tm_basemap("OpenStreetMap")
```

## Rasterize, Masking, CellSize, and Zonal 
```{r}
eez_rast <- rasterize(regions, 
                 # template- using extent, resolution, crs
                 suitable, 
                 # use region column
                 field = "rgn")


# Mask
suitable_mask <- mask(suitable,regions)

# Cell size
cell_area <- cellSize(suitable_mask, unit = "km")

# Sum suitable area by EEZ
area_by_eez_zonal <- zonal(cell_area * suitable_mask, eez_rast, fun = "sum", na.rm = TRUE) %>% 
  rename("suitable_area_km2" = area) %>% 
  mutate(suitable_area_km2 = as.numeric(suitable_area_km2)) %>% 
  as_tibble() %>% 
  arrange(desc(suitable_area_km2))


area_by_eez_zonal %>%
  mutate(suitable_area_km2 = round(suitable_area_km2, 2)) %>% 
  kbl(
    caption = "Suitable Area by EEZ (km²)",
    col.names = c("EEZ Region", "Suitable Area (km²)")
  ) %>%
  kable_classic(full_width = FALSE, html_font = "Arial")



```
# Plot
```{r, message=FALSE}

tm_shape(regions) +
  tm_polygons("rgn", palette = "Set3", title = "EEZ Regions", alpha = 1) +
tm_shape(suitable_mask) +
  tm_raster(alpha = 0.6, title = "Suitable Area") +
tm_shape(regions) +
  # Adding labels
  tm_text("rgn", size = 0.5) +   
tm_layout(
  legend.outside.position = TRUE)+
tm_scale_bar(position = c(-.01, 0.08)) +
tm_compass(position = c("right", "top"))+
  tm_basemap("OpenStreetMap")



```

# Join Dataframes 
```{r}
#Set as simple features to conserve geometry
region_sf <- st_as_sf(regions)

# Join zonal data and calculate percentage in one step
eez_sf <- region_sf %>%
  left_join(area_by_eez_zonal, by = "rgn") %>%
  mutate(perc_area_km2 = (area_km2 / suitable_area_km2) * 100)

# Table 
eez_sf %>% 
  st_drop_geometry() %>% 
  as_tibble() %>% 
  dplyr::select(rgn, suitable_area_km2, perc_area_km2) %>% 
  mutate(
    suitable_area_km2 = round(suitable_area_km2, 2),
    perc_area_km2 = round(perc_area_km2, 2)
  ) %>% 
  kbl(
    caption = "Suitable Area and Percentage by EEZ",
    col.names = c("EEZ Region", "Suitable Area (km²)", "Percent of Region (%)")
  ) %>% 
  kable_classic(full_width = FALSE, html_font = "Arial")

```
- The table shows the suitable area for oyster aquaculture across West Coast EEZs. Central California has the largest suitable area at 4,070 km², followed by Southern California with 3,757 km². Washington and Oregon have moderate areas of 2,378 km² and 1,074 km². Northern California has the smallest at 178 km². Overall, the most favorable regions for oyster aquaculture are Central and Southern California.

# Map- After joining checking for Oysters along the West Coast 
```{r, message=FALSE}
tm_shape(eez_sf) +
  tm_polygons(
    "suitable_area_km2",
    palette = "-mako",
    style = "cont",
    title = "Suitable Area (km²)"
  ) +
  tm_text(
    "rgn",
    size = 0.45,
    col = "black",
    fontface = "bold",
    bgcol = "antiquewhite",
    bgcol_alpha = 0.2) +
  tm_layout(
    main.title = "Suitable Area for Oyster Aquaculture in California EEZs\nPercent of Total EEZ Area Meeting Preferred Temperature & Depth Criteria",
    main.title.size = 0.8,       # Controls title + subtitle size
    main.title.fontface = "bold",
    legend.outside = TRUE,
    legend.outside.position = "right",
    component.autoscale = FALSE,
    outer.margins = c(0.01, 0.25, 0.01, 0.05)
  ) +
  tm_scale_bar(position = c(-.02, 0.08)) +
  tm_compass(
    type = "arrow",
    position = c("right", "top")
  )+
  tm_basemap("OpenStreetMap")



```
# Generalizeable Workflow Function with Map
#### **Important** Load in datasets before using function:
- CRS, Extent, Resolution, and Geometry all need to match before using function.
```{r}
suit_func <- function(
  sst_raster,
  depth_raster,
  eez_sf,
  min_sst,
  max_sst,
  min_depth,
  max_depth,
  species_name
) {
 
  
  # Reclassify Depth
  rcl_depth <- matrix(c(
    -Inf, min_depth, 0,
     min_depth, max_depth, 1,
     max_depth, Inf, 0
  ), byrow = TRUE, ncol = 3)

  depth_suit <- classify(depth_raster, rcl_depth)
  
  # Reclassify SST
  rcl_sst <- matrix(c(
    -Inf, min_sst, 0,
     min_sst, max_sst, 1,
     max_sst, Inf, 0
  ), byrow = TRUE, ncol = 3)

  sst_suit <- classify(sst_raster, rcl_sst)
  
  # Combine Stack
  suit_env <- depth_suit * sst_suit
  
  # Mask
  suit_mask <- mask(suit_env,regions)
  
  # Rasterize EEZ polygons to match raster grid
  eez_rast <- terra::rasterize(eez_sf, suit_mask, field = "rgn")
  
  # Zonal area (km^2)
  cell_area <- cellSize(suit_mask, unit = "km")

  area_table <- zonal(cell_area * suit_mask, eez_rast, fun = "sum", na.rm = TRUE) %>% 
  rename("suitable_area_km2_new" = area) %>% 
  mutate(suitable_area_km2 = as.numeric(suitable_area_km2_new)) %>% 
  as_tibble() %>% 
  arrange(desc(suitable_area_km2))
  
  # Join back to EEZ polygons for mapping
  eez_joined <- left_join(eez_sf, area_table, by = "rgn")
  
    # Create table
  eez_table <- eez_joined %>%
    st_drop_geometry() %>%
    # to view for each species
    as.data.frame() %>%
    # select columns to show in figure
    dplyr::select(rgn, suitable_area_km2_new) %>%
    # rename column
    rename(Region = rgn) %>% 
    # new column
    mutate(suitable_area_km2_new = round(suitable_area_km2_new, 2)) %>% 
    rename("Suitable Area(km²)" = suitable_area_km2_new)
  # print
  print(eez_table)

  
  # Plot It!
  suit_func_map <- 
    tm_shape(eez_joined) +
      tm_polygons(
        "suitable_area_km2_new",
        palette = "-mako",
        style = "cont",
        title = "Suitable Area (km²)"
      ) +
      tm_text("rgn", 
              size = 0.45, 
              col = "black", 
              fontface = "bold",
              bgcol = "antiquewhite",
              bgcol_alpha = 0.2) +
      tm_layout(
        main.title = paste(
          "Suitable Area for", species_name,
          "\nBased on Preferred Temperature and Depth"
        ),
        main.title.size = 0.8,
        main.title.fontface = "bold",
        legend.outside = TRUE,
        legend.outside.position = "right",
        component.autoscale = FALSE,
        outer.margins = c(0.01, 0.25, 0.01, 0.05)
      ) +
      tm_scale_bar(position = c(-.02, 0.08)) +
      tm_compass(type = "arrow", position = c("right", "top"))+
      tm_basemap("OpenStreetMap")
  
  return(suit_func_map)
}

```

# Use Function with a New Species
#### **Aplysia californica**, California sea hare -
- Depth range: 0 - 22 m
- Sea Level: 13.4 - 27.1 
```{r, message=FALSE}

# California sea hare
suit_func(
  sst_raster = sst_mean,
  depth_raster = depth_resampled,
  eez_sf = eez_sf,
  min_sst = 13.4,
  max_sst = 27.1,
  min_depth = -22,
  max_depth = 0,
  species_name = "California Sea Hare (Aplysia californica)"
)
```
- The California sea hare *Aplysia californica* has suitable habitat primarily in Central California (118.79 km²) and Southern California (499.63 km²). No suitable habitat was identified in Oregon, Northern California, or Washington.

#### Another Species California spiny lobster (Panulirus Interruptus) for fun
```{r, message=FALSE}
suit_func(
  sst_raster = sst_mean,
  depth_raster = depth_resampled,
  eez_sf = eez_sf,
  min_sst = 12,
  max_sst = 24,
  min_depth = -150,
  max_depth = 0,
  species_name = "California spiny lobster (Panulirus Interruptus)"
)
```

- The California spiny lobster (*Panulirus Interruptus*) has suitable habitat primarily in Southern California (8093.85 km²), Central California (3992.41 km²), Oregon (585.03 km²), and Washington (175.57 km²). No suitable habitat was identified in Northern California.

